{% extends "base.html" %}

{% block content %}
<header>
    <h2>{{ group.name }}</h2>
</header>

<section class="grid">
    <article>
        <h6>ç¾åœ¨ã®ãƒ¡ãƒ³ãƒãƒ¼</h6>
        <ul>
            {% for m in group.members %}
                <li>{{ m.name }}</li>
            {% endfor %}
        </ul>
    </article>
    
    <article>
        <h6>ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ </h6>
        <form action="/groups/{{ group.id }}/members" method="post">
            <label for="name" class="visually-hidden">ãƒ¡ãƒ³ãƒãƒ¼å</label>
            <input type="text" id="name" name="name" placeholder="æ–°ã—ã„åå‰" required>
            <button type="submit">è¿½åŠ </button>
        </form>
    </article>
</section>

<hr> <section class="card">
    <h4>â• ç«‹æ›¿ã‚’è¨˜éŒ²ã™ã‚‹</h4>
    <form action="/groups/{{ group.id }}/expenses" method="post">
        <div class="grid">
            <div>
                <label for="description">å†…å®¹</label>
                <input type="text" name="description" placeholder="ä¾‹: ãƒ©ãƒ³ãƒä»£" required>
            </div>
            <div>
                <label for="amount">é‡‘é¡ (å††)</label>
                <input type="number" name="amount" placeholder="3000" required>
            </div>
        </div>

        <label for="payer_id">èª°ãŒæ‰•ã£ãŸï¼Ÿ</label>
        <select name="payer_id" required>
            {% for member in group.members %}
                <option value="{{ member.id }}">{{ member.name }}</option>
            {% endfor %}
        </select>

        <label>èª°ã®åˆ†ï¼Ÿ (è¤‡æ•°é¸æŠå¯)</label>
        <div class="grid">
            {% for member in group.members %}
            <label>
                <input type="checkbox" name="target_ids" value="{{ member.id }}" checked>
                {{ member.name }}
            </label>
            {% endfor %}
        </div>

        <button type="submit" style="margin-top: 1rem;">ç™»éŒ²ã™ã‚‹</button>
    </form>
</section>


<section class="card">
    <h4>ğŸ“Š ç²¾ç®—ã‚µãƒãƒªãƒ¼</h4>
    <p><strong>ã‚°ãƒ«ãƒ¼ãƒ—åˆè¨ˆæ”¯å‡º: Â¥{{ "{:,.0f}".format(total_group_spend) }}</strong></p>
    
    <table role="grid">
        <thead>
            <tr>
                <th>ãƒ¡ãƒ³ãƒãƒ¼</th>
                <th>æ”¯æ‰•ã£ãŸé¡</th>
                <th>è² æ‹…ã™ã¹ãé¡</th>
                <th>å·®é¡ ( +/- )</th>
            </tr>
        </thead>
        <tbody>
            {% for member_id, data in settlement.items() %}
            <tr>
                <td><strong>{{ data.name }}</strong></td>
                <td>Â¥{{ "{:,.0f}".format(data.paid) }}</td>
                <td>Â¥{{ "{:,.0f}".format(data.owed) }}</td>
                
                {% set balance = data.balance %}
                <td style="color: {{ 'green' if balance > 0 else ('red' if balance < 0 else 'black') }}; font-weight: bold;">
                    
                    {% if balance > 0 %}+{% endif %}{{ "{:,.0f}".format(balance) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <details open> <summary><strong>å…·ä½“çš„ãªç²¾ç®—æ–¹æ³• (æœ€å°å›æ•°)</strong></summary>
        {% if transactions %}
            <ul>
                {% for tx in transactions %}
                    <li>{{ tx }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>ç²¾ç®—ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚</p>
        {% endif %}
    </details>
</section>


<section>
    <h3>å±¥æ­´ä¸€è¦§</h3>
    {% if group.expenses %}
        <table role="grid">
            <thead>
                <tr>
                    <th>å†…å®¹</th>
                    <th>é‡‘é¡</th>
                    <th>æ”¯æ‰•è€…</th>
                    <th>å¯¾è±¡</th>
                    <th>æ—¥æ™‚</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in group.expenses %}
                <tr>
                    <td>{{ expense.description }}</td>
                    <td>Â¥{{ "{:,}".format(expense.amount) }}</td>
                    <td><strong>{{ expense.payer.name }}</strong></td>
                    <td>
                        <small>
                        {% for target in expense.targets %}
                            {{ target.name }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        </small>
                    </td>
                    <td><small>{{ expense.created_at.strftime('%m/%d %H:%M') }}</small></td>
                    
                    <td style="display: flex; gap: 0.5rem; align-items: center;">
                        <a href="/expenses/{{ expense.id }}/edit"
                           role="button"
                           class="primary outline"
                           style="padding: 0.2rem 0.5rem; margin:0; font-size: 0.8rem;">ç·¨é›†</a>

                        <a href="/expenses/{{ expense.id }}/delete" 
                           onclick="return confirm('ã€Œ{{ expense.description }} (Â¥{{ "{:,}".format(expense.amount) }})ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" 
                           role="button" 
                           class="secondary outline" 
                           style="padding: 0.2rem 0.5rem; margin:0; font-size: 0.8rem;">å‰Šé™¤</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>ã¾ã ç«‹æ›¿è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</section>

<a href="/" role="button" class="secondary outline">â† ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã«æˆ»ã‚‹</a>
{% endblock %}